name: dependency-audit

on:
  schedule:
    # Run on the first day of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  issues: write

jobs:
  audit-dart:
    name: Audit Dart Package Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Get dependencies
        working-directory: packages/dart
        run: dart pub get

      - name: Check for outdated dependencies
        id: outdated
        working-directory: packages/dart
        run: |
          echo "## Dart Package - Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          dart pub outdated --mode=outdated || true
          dart pub outdated --mode=outdated >> $GITHUB_STEP_SUMMARY || true

      - name: Security audit
        id: audit
        working-directory: packages/dart
        run: |
          echo "## Dart Package - Security Audit" >> $GITHUB_STEP_SUMMARY
          dart pub audit || true
          dart pub audit >> $GITHUB_STEP_SUMMARY || true

  audit-flutter:
    name: Audit Flutter Package Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Get dependencies
        working-directory: packages/flutter
        run: flutter pub get

      - name: Check for outdated dependencies
        id: outdated
        working-directory: packages/flutter
        run: |
          echo "## Flutter Package - Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          flutter pub outdated --mode=outdated || true
          flutter pub outdated --mode=outdated >> $GITHUB_STEP_SUMMARY || true

      - name: Security audit
        id: audit
        working-directory: packages/flutter
        run: |
          echo "## Flutter Package - Security Audit" >> $GITHUB_STEP_SUMMARY
          dart pub audit || true
          dart pub audit >> $GITHUB_STEP_SUMMARY || true

  create-issue:
    name: Create Issue if Security Vulnerabilities Found
    needs: [audit-dart, audit-flutter]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue for security vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const title = '[Security] Dependency vulnerabilities detected';
            const body = `## Security Vulnerabilities Detected

            The monthly dependency audit has detected security vulnerabilities in our dependencies.

            ### Action Required
            1. Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Update affected dependencies
            3. Test thoroughly
            4. Create a PR with security fixes

            ### Resources
            - [VERSIONING_POLICY.md](${context.payload.repository.html_url}/blob/master/VERSIONING_POLICY.md)
            - [Dart Security Best Practices](https://dart.dev/guides/libraries/secure)

            ---
            **Auto-generated by dependency-audit workflow**
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('[Security] Dependency vulnerabilities')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'high-priority']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `New vulnerabilities detected in [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            }
